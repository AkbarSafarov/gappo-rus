{"version":3,"names":[],"mappings":"","sources":["other_prj/video.widget.js"],"sourcesContent":["class VideoWidget {\n\tconstructor(element) {\n\t\tthis.widget = element;\n\t\tthis.videoContainer = this.widget.querySelector('[data-video=\"container\"]');\n\t\tthis.video = this.widget.querySelector('video');\n\t\tthis.closeBtn = this.widget.querySelector('[data-close]');\n\t\tthis.soundToggle = this.widget.querySelector('[data-sound]');\n\t\tthis.minimizeBtn = this.widget.querySelector('[data-minimize]');\n\t\tthis.playPauseBtn = this.widget.querySelector('[data-play-pause]');\n\t\tthis.fullscreenBtn = this.widget.querySelector('[data-fullscreen]');\n\t\tthis.videoDesktop = this.widget.getAttribute('data-desktop');\n\t\tthis.videoMobile = this.widget.getAttribute('data-mobile');\n\n\t\tthis.loader = document.createElement('div')\n\t\tthis.loader.setAttribute('data-video-loader', '');\n\t\tthis.videoContainer?.prepend(this.loader);\n\n\t\tthis.isMobile = (window.innerWidth <= 768);\n\n\t\t// this.playPauseIcon = null;\n\n\n\t\tthis.mimeTypesByExtension = {\n\t\t\tmp4: 'video/mp4',\n\t\t\twebm: 'video/webm',\n\t\t\togg: 'video/ogg',\n\t\t\tmov: 'video/quicktime',\n\t\t\tm4v: 'video/x-m4v'\n\t\t};\n\n\n\t\tthis.iconMap = {\n\t\t\t'volume-high': 'M533.6 32.5C598.5 85.2 640 165.8 640 256s-41.5 170.7-106.4 223.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C557.5 398.2 592 331.2 592 256s-34.5-142.2-88.7-186.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM473.1 107c43.2 35.2 70.9 88.9 70.9 149s-27.7 113.8-70.9 149c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C475.3 341.3 496 301.1 496 256s-20.7-85.3-53.2-111.8c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zm-60.5 74.5C434.1 199.1 448 225.9 448 256s-13.9 56.9-35.4 74.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C393.1 284.4 400 271 400 256s-6.9-28.4-17.7-37.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM301.1 34.8C312.6 40 320 51.4 320 64l0 384c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352 64 352c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64l67.8 0L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3z',\n\t\t\t'volume-xmark': 'M301.1 34.8C312.6 40 320 51.4 320 64l0 384c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352 64 352c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64l67.8 0L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3zM425 167l55 55 55-55c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-55 55 55 55c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-55-55-55 55c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l55-55-55-55c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0z',\n\t\t\t'minimize': 'M32 416c-17.7 0-32 14.3-32 32s14.3 32 32 32l448 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 416z',\n\t\t\t'fullscreen': 'M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z',\n\t\t\t'close': 'M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z',\n\t\t\t'play': 'M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80L0 432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z',\n\t\t\t'pause': 'M48 64C21.5 64 0 85.5 0 112L0 400c0 26.5 21.5 48 48 48l32 0c26.5 0 48-21.5 48-48l0-288c0-26.5-21.5-48-48-48L48 64zm192 0c-26.5 0-48 21.5-48 48l0 288c0 26.5 21.5 48 48 48l32 0c26.5 0 48-21.5 48-48l0-288c0-26.5-21.5-48-48-48l-32 0z'\n\t\t};\n\t\tthis.iconViewBoxMap = {\n\t\t\t'volume-high': '0 0 640 512',\n\t\t\t'volume-xmark': '0 0 576 512',\n\t\t\t'minimize': '0 0 512 512',\n\t\t\t'fullscreen': '0 0 448 512',\n\t\t\t'close': '0 0 384 512',\n\t\t\t'play': '0 0 384 512',\n\t\t\t'pause': '0 0 320 512'\n\t\t}\n\n\t\tthis.init();\n\t}\n\n\tsetCookie(name, value, time) {\n\t\tconst date = new Date();\n\t\tdate.setTime(date.getTime() + time);\n\t\tconst expires = \"expires=\" + date.toUTCString();\n\t\tdocument.cookie = name + \"=\" + value + \";\" + expires + \";path=/;SameSite=Lax\";\n\t}\n\n\tgetCookie(name) {\n\t\tconst cname = name + \"=\";\n\t\tconst decodedCookie = decodeURIComponent(document.cookie);\n\t\tconst ca = decodedCookie.split(';');\n\t\tfor (let i = 0; i < ca.length; i++) {\n\t\t\tlet c = ca[i];\n\t\t\twhile (c.charAt(0) == ' ') c = c.substring(1);\n\t\t\tif (c.indexOf(cname) === 0) return c.substring(cname.length, c.length);\n\t\t}\n\t\treturn \"\";\n\t}\n\n\tinit() {\n\t\tthis.loadVideo();\n\t\tthis.setupIcons();\n\t\tthis.setupEventListeners();\n\t}\n\n\tcreateSVGIcon(iconName, className = '') {\n\t\tconst svgNS = 'http://www.w3.org/2000/svg';\n\t\tconst pathData = this.iconMap[iconName];\n\t\tconst viewBox = this.iconViewBoxMap[iconName];\n\n\t\tif (!pathData) {\n\t\t\tconsole.error(`Иконка \"${iconName}\" не найдена`);\n\t\t\treturn null;\n\t\t}\n\t\tif (!viewBox) {\n\t\t\tconsole.error(`ViewBox \"${iconName}\" не найден`);\n\t\t\treturn null;\n\t\t}\n\n\t\tconst svg = document.createElementNS(svgNS, 'svg');\n\t\tsvg.setAttribute('viewBox', viewBox);\n\t\tsvg.setAttribute('aria-hidden', 'true');\n\t\tsvg.setAttribute('focusable', 'false');\n\t\tsvg.setAttribute('role', 'img');\n\t\tif (className) svg.classList.add(className);\n\n\t\tconst path = document.createElementNS(svgNS, 'path');\n\t\tpath.setAttribute('d', pathData);\n\t\tpath.setAttribute('fill', 'currentColor');\n\n\t\tsvg.appendChild(path);\n\t\treturn svg;\n\t}\n\n\tupdateIcon(button, iconName) {\n\t\tconst icon = button.querySelector('svg');\n\t\tif (icon) {\n\t\t\tconst pathData = this.iconMap[iconName];\n\t\t\tconst viewBox = this.iconViewBoxMap[iconName];\n\t\t\tif (viewBox)\n\t\t\t\ticon.setAttribute('viewBox', viewBox);\n\t\t\tif (pathData)\n\t\t\t\ticon.querySelector('path').setAttribute('d', pathData);\n\t\t}\n\t}\n\n\tsetupIcons() {\n\t\tthis.soundToggle.appendChild(this.createSVGIcon(this.video.muted ? 'volume-xmark' : 'volume-high'));\n\t\tthis.minimizeBtn.appendChild(this.createSVGIcon('minimize'));\n\t\tthis.closeBtn.appendChild(this.createSVGIcon('close'));\n\t\tthis.fullscreenBtn.appendChild(this.createSVGIcon('fullscreen'));\n\t\tthis.playPauseBtn.appendChild(this.createSVGIcon(this.video.paused ? 'play' : 'pause'));\n\t}\n\n\tasync getVideoMimeType(url) {\n\t\ttry {\n\t\t\tconst response = await fetch(url, { method: 'HEAD' });\n\t\t\tconst contentType = response.headers.get('Content-Type');\n\t\t\tif (contentType) return contentType;\n\t\t} catch (e) {\n\t\t\tconsole.error('Ошибка получения заголовков', e);\n\t\t}\n\n\t\tconst extMatch = url.match(/\\.([a-z0-9]+)(\\?|#|$)/i);\n\t\tif (extMatch) {\n\t\t\tconst ext = extMatch[1].toLowerCase();\n\t\t\treturn this.mimeTypesByExtension[ext] || null;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tasync loadVideo() {\n\t\t// const isMobile = window.innerWidth <= 768;\n\t\tconst videoSource = (this.isMobile && this.videoMobile) ? this.videoMobile : this.videoDesktop;\n\n\t\t// Очищаем предыдущие источники\n\t\twhile (this.video.firstChild) this.video.removeChild(this.video.firstChild);\n\n\t\tconst source = document.createElement('source');\n\t\tsource.src = videoSource;\n\t\tlet mimeType = await this.getVideoMimeType(videoSource);\n\n\t\tif (!mimeType) {\n\t\t\tmimeType = 'video/mp4';\n\t\t}\n\t\tsource.type = mimeType;\n\t\tthis.video.appendChild(source);\n\n\t\tthis.video.load();\n\t\tthis.loader.style.display = 'block';\n\n\t\tthis.video.addEventListener('loadeddata', () => {\n\t\t\tthis.loader.style.display = 'none';\n\n\t\t\tconst playPromise = this.video.play();\n\t\t\tif (playPromise !== undefined) {\n\t\t\t\tplayPromise.catch(error => {\n\t\t\t\t\tconsole.log('Автовоспроизведение предотвращено:', error);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.video.disablePictureInPicture = false;\n\t\t});\n\t}\n\n\tsetupEventListeners() {\n\t\t// Обработчик для расширения виджета\n\t\tthis.videoContainer.addEventListener('click', (e) => {\n\t\t\tif (!this.widget.classList.contains('expanded'))\n\t\t\t\tthis.expandWidget();\n\t\t\telse if (this.widget.classList.contains('expanded'))\n\t\t\t\tthis.togglePlayPause();\n\t\t});\n\n\t\t// Закрытие виджета (полное удаление)\n\t\tthis.closeBtn.addEventListener('click', (e) => {\n\t\t\te.stopPropagation();\n\t\t\tthis.widget.remove();\n\t\t\tthis.setCookie('vm-video-closed', 'true', 3 * 60 * 1000);\n\t\t});\n\n\t\t// Переключение звука\n\t\tthis.soundToggle.addEventListener('click', (e) => {\n\t\t\te.stopPropagation();\n\t\t\tthis.toggleSound();\n\t\t});\n\n\t\t// Свернуть виджет\n\t\tthis.minimizeBtn.addEventListener('click', (e) => {\n\t\t\te.stopPropagation();\n\t\t\tthis.minimizeWidget();\n\t\t});\n\n\t\t// Пауза/воспроизведение (только в expanded режиме)\n\t\tthis.playPauseBtn.addEventListener('click', (e) => {\n\t\t\tif (!this.widget.classList.contains('expanded'))\n\t\t\t\treturn;\n\t\t\te.stopPropagation();\n\t\t\tthis.togglePlayPause();\n\t\t});\n\n\t\t// Полноэкранный режим\n\t\tthis.fullscreenBtn.addEventListener('click', (e) => {\n\t\t\te.stopPropagation();\n\t\t\tthis.toggleFullscreen();\n\t\t});\n\n\t\tthis.video.addEventListener('dblclick', (e) => {\n\t\t\te.stopPropagation();\n\t\t\tthis.toggleFullscreen();\n\t\t});\n\n\t\t// Клик по документу для сворачивания\n\t\tdocument.addEventListener('click', (e) => {\n\t\t\tif (this.widget.classList.contains('expanded') && !this.widget.contains(e.target))\n\t\t\t\tthis.minimizeWidget();\n\t\t});\n\n\t\t// Обработка полноэкранного режима\n\t\tdocument.addEventListener('fullscreenchange', () => this.handleFullscreenChange());\n\t\tdocument.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange());\n\t\tdocument.addEventListener('mozfullscreenchange', () => this.handleFullscreenChange());\n\t\tdocument.addEventListener('msfullscreenchange', () => this.handleFullscreenChange());\n\t}\n\n\thandleFullscreenChange() {\n\t\tif (this.isFullscreen()) {\n\t\t\tthis.video.controls = true;\n\t\t} else {\n\t\t\tthis.video.controls = false;\n\t\t}\n\t}\n\n\texpandWidget() {\n\t\tthis.widget.classList.add('expanded');\n\t\tthis.toggleSound();\n\t\tthis.togglePlayPause(false);\n\t}\n\n\tminimizeWidget() {\n\t\tthis.widget.classList.remove('expanded');\n\t\tthis.toggleSound(true);\n\n\t}\n\n\ttoggleFullscreen() {\n\t\tconst requestFullscreen = element => {\n\t\t\tif (element.requestFullscreen) return element.requestFullscreen();\n\t\t\tif (element.webkitRequestFullscreen) return element.webkitRequestFullscreen();\n\t\t\tif (element.mozRequestFullScreen) return element.mozRequestFullScreen();\n\t\t};\n\t\tconst exitFullscreen = element => {\n\t\t\tif (element.exitFullscreen) return element.exitFullscreen();\n\t\t\tif (element.webkitExitFullscreen) return element.webkitExitFullscreen();\n\t\t\tif (element.mozCancelFullScreen) return element.mozCancelFullScreen();\n\t\t}\n\n\t\tthis.isFullscreen() ? exitFullscreen(document) : requestFullscreen(this.video);\n\n\t}\n\n\ttoggleSound(muted = null) {\n\t\tthis.video.muted = muted ?? !this.video.muted;\n\t\tthis.updateIcon(this.soundToggle, this.video.muted ? 'volume-xmark' : 'volume-high');\n\t\tthis.soundToggle.setAttribute('aria-label', this.video.muted ? 'Включить звук' : 'Выключить звук');\n\t}\n\n\ttogglePlayPause(paused = null) {\n\t\tif (paused === null) {\n\t\t\tthis.updateIcon(this.playPauseBtn, this.video.paused ? 'play' : 'pause');\n\t\t\tthis.soundToggle.setAttribute('aria-label', this.video.paused ? 'Воспроизвести' : 'Пауза');\n\t\t\tthis.video.paused ? this.video.play() : this.video.pause();\n\t\t}\n\t}\n\n\tisFullscreen() {\n\t\treturn document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement;\n\t}\n\n\tdebounce(func, wait) {\n\t\tlet timeout;\n\t\treturn () => {\n\t\t\tconst context = this;\n\t\t\tclearTimeout(timeout);\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\tfunc.apply(context);\n\t\t\t}, wait);\n\t\t};\n\t}\n\n}"],"file":"video.widget.js"}